<!DOCTYPE html>
<html lang='es'>
<head>
	<meta charset="utf-8" />
	<title>mediateca guifibaix</title>
	<meta content="" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
<!--	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>-->
<!--	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1/jquery-ui.min.js"></script>-->
<!--	<script src="//code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>-->
<!--	<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />-->
<!--	<link rel="stylesheet" href="//code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css">-->
	<link rel="stylesheet" href="jquery.mobile-1.4.2.min.css">
	<link rel="stylesheet" href="jquery-mobile-theme-mediateca/themes/mediateca.min.css" />
	<link rel="stylesheet" href="jquery-mobile-theme-mediateca/themes/jquery.mobile.icons.min.css" />
<!--	<link rel="stylesheet" href="//code.jquery.com/mobile/1.4.2/jquery.mobile.structure-1.4.2.min.css" /> -->
	<link rel="stylesheet" href="jquery-ui-1.10.4.css" />
	<script src="jquery-2.1.0.min.js"></script>
	<script src="jquery.mobile-1.4.2.min.js"></script>
	<script src="jquery-ui-1.10.4.min.js"></script>

	<style>
		#mediatypelist li img {
			display: block;
			margin: auto;
			padding: 0px;
		}
		#mediatypelist ul,
		#mediatypelist ul li,
		#mediatypelist ul li a
		{
			padding-bottom: 0px;
			margin-bottom: 0px;
			min-height: 3em;
		}
		#mediatypelist .ui-li-thumb {
			max-height: 18px;
			max-width: 18px;
		}

		.itembrowser {
			text-align: center;
		}
		.itembrowser .mediaitem {
			transition: all 0.5s;
			display: inline-block;
			position: relative;
			border: 3pt solid black;
			margin: 10px;
			box-shadow: 2pt 3pt 6pt #500;
			max-width: 40%;
			max-height: 40%;
			width: 200px;
			height: auto;

			background-image: url('media/logo-guifibaix-mediateca.svg');
			background-color: #111;
			background-position: center center;
			background-repeat: no-repeat;
			background-size: contain;
		}
		.itembrowser .mediaitem:before {
			display:block;
			position: relative;
			content: "";
			padding-bottom: 150%;
			width: 100%;
			height: 0;
			overflow: hidden;
		}
		.itembrowser .mediaitem:hover {
			box-shadow: 0pt 0pt 8pt #a7f;
		}
		.itembrowser .mediaitem img.poster {
			/*border: 1pt solid red;*/
			display: block;
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			max-width: 100%;
			max-height: 100%;
			margin-left: auto;
			margin-right: auto;
			margin-bottom: auto;
			margin-top: 0;
		}
		.itembrowser .mediaitem .mediadescription {
			transition: all 0.5s;
			display: none;
		}
		.itembrowser .mediaitem:hover .mediadescription {
			transition: all 0.5s;
			display: block;
			position: absolute;
			bottom: 0;
			left: 0;
			right: 0;
			padding: 8px;
			opacity: 0.8;
			background-color: #333;
			font-weight: bold;
			color: #ff3;
		}
		#homepage h1 {
			background-position: 50% 50%;
			background-image: url(media/logo-guifibaix-mediateca.svg);
			background-repeat: no-repeat;
			background-size: auto 210%;
		}
	</style>
</head>
<body >
<div data-role="page" id="homepage">
	<div data-role="header" data-position='fixed'>
		<h1></h1>
		<a 
			id="mediatype" 
			href='#mediatypelist' 
			data-role='button'
			data-rel="popup"  
			data-icon='arrow-d'	
			data-iconpos='right'
			value='movies'
			>
			<img title='Pelis' src="media/movie.svg" width='20px'>
		</a>
		<div id='mediatypelist' data-role="popup" data-theme="a">
			<ul data-role="listview" data-inset="true" style="min-width:230px;">
				<li data-role="divider">Tipo de medio</li>
				<li><a href='#homepage' onclick="changeMediaType(this)" value='movies'><img src="media/movie.svg" />Pelis</a></li>
				<li><a href='#homepage' onclick="changeMediaType(this)" value='shows'><img src="media/show.svg" />Séries</a></li>
				<li><a href='#homepage' onclick="changeMediaType(this)" value='comics'><img src="media/comic.svg" />Comic</a></li>
				<li><a href='#homepage' onclick="changeMediaType(this)" value='music'><img src="media/music.svg" />Música</a></li>
				<li><a href='#homepage' onclick="changeMediaType(this)" value='books'><img src="media/book.svg" />Libros</a></li>
				<li><a href='#homepage' onclick="changeMediaType(this)" value='games'><img src="media/game.svg" />Juegos</a></li>
			</ul>
		</div>
		<a
			id='#sortchoser'
			href='#sortlist'
			data-role='button'
			data-rel="popup"  
			data-icon='arrow-d'
			data-iconpos='right'
			value="new"
			>
			<img title='Pelis' src="media/movie.svg" width='20px'>
		</a>
		<form id='searchform'>
		<input type="search" name="q" id="mediasearch" value="" placeholder='Search...' data-clear-btn="true" data-inline="true" />
		</form>
	</div>
	<div data-role="main">
		<div class="itembrowser"></div>
	</div>
	<div data-role="footer"  data-position='fixed'>
		<p>© 2014 GuifiBaix</p>
	</div>
</div>

<script>
function changeMediaType(element)
{
	var type = $(element).attr("value");
	var image = $(element).find("img").attr("src");
	var text = $(element).text();

	var mediatype = $("#mediatype")
	$(mediatype).attr("value",type);
	$(mediatype).find("img").attr("src",image);
	$(mediatype).find("img").attr("title",text);
}
$( "#searchform" ).submit(function( event ) {
	search($("#mediatype").attr("value"), $("#mediasearch").val())
	event.preventDefault();
});
function search(type, query) {
	clearMediaItems();
	addSearchResultsMediaItems(query);
}
</script>

<style>
.extendedinfo
{
	padding: 3% 3%;
}
.extendedinfo .extendedinfoimage,
.extendedinfo .extendedinfoheader,
.extendedinfo .extendedinforating,
.extendedinfo .extendedinfodata
{
	display: block;
}
.extendedinfoimage {
	float: right;
	display: block;
	height: auto;
	width: 800px;
	max-width: 30%;
	max-height: 100%;
	box-shadow: 2pt 2pt 4pt black;
	margin-left: 1em;
}
.extendedinfoheader {
	color: #b64;
	padding: 15px 20px;
	background-color: #311;
	border-radius: 10px;
	border: 1px #411 solid;
	box-shadow: 0pt 0pt 4pt #755;
	text-shadow: 2pt 2pt 4pt black;
}
.extendedinfoheader .extendedinfotype {
	height: 1em;
}
.extendedinfoheader .extendedinfoyear {
	display: inline-block;
	color: #46f;
	color: #711;
}
.extendedinfo b {
	color: #963;
}

.extendedinfo .extendedinforating {
	display: inline-block;
	position: relative;
	width: 6em;
	max-width: 40%;
	min-width: 5em;
	margin: 0;
	padding: 0;
	background-image: url("media/star-empty.svg");
	background-repeat: repeat-x;
	background-position: left center;
	background-size: auto 100%;
}
.extendedinfo .extendedinforating .rating {
	width: 0;
	height: 0;
	margin: 0;
	padding-right: 0;
	padding-bottom: 0;
	padding-top: 20%; /* percent for one star of all of them */
	padding-left: 0%; /* percent of the stars */
	background: inherit;
	background-image: url("media/star.svg");
}
.extendedinfo .extendedinforating:hover .rating {
	padding-left: 100%;
	background-image: url("media/star-active.svg");
}

.extendedinfoactions {
	text-align: center;
}
.extendedinfoactions .button:before {
	position: relative;
	padding-top: 100%;
}
.extendedinfoactions .button {
	position: relative;
	background-position: 50% 50%;
	background-size: 90%;
	background-color: #111;
	background-repeat: no-repeat;
	margin-left: 5px;
	margin-right: 5px;
	min-height: 40%;
	width: 30px;
	height: 30px;
	max-width: 25%;
}
.extendedinfoactions .button.play {
	background-image: url('media/icon-play.svg');
}
.extendedinfoactions .button.info {
	background-image: url('media/icon-info.svg');
}
.extendedinfoactions .button.download {
	background-image: url('media/icon-download.svg');
}
.extendedinfoactions .button:hover {
	opacity: 1;
}

</style>

<div data-role="page" id="movieinfo"  data-title="Movie information">
	<div data-role='header' data-position='fixed'>
		<a href=='#' class='ui-btn ui-icon-back ui-btn-corner-all ui-btn-icon-notext' data-rel='back'> </a>
		<h1>Information</h1>
	</div>
	<div data-role="main">
		<div class="extendedinfo">
			<img class="extendedinfoimage poster"></img>
			<h2 class='extendedinfoheader'>
				<img class='extendedinfotype' src='media/movie.svg'>
				<span class='extendedinfotitle'>Title</span>
				<span class='extendedinfoyear'>(year)</span>
				<div class='extendedinforating'><div class='rating'></div></div>
			</h2>
			<ul class='extendedinfodata' ></ul>
			<div class='versions'>
				<h3>Versiones disponibles:</h3>
				<ul class='movieversions' data-role="listview" data-inset="true">
					<li><a href=''>cosa 1</a></li>
				</ul>
			</div>
		</div>
	</div>
	<div data-role='footer' data-position='fixed'>
		<div data-role='toolbar' class='extendedinfoactions'>
			<a
				href=""
				class='ui-btn ui-shadow ui-corner-all button play' 
				data-transition='slidedown'
				></a>
			<a 
				href="http://imdb.com" 
				class="ui-btn ui-shadow ui-corner-all button info"
				></a>
			<a
				href=""
				class="ui-btn ui-shadow ui-corner-all button download"
				></a>
		</div>
	</div>
</div>

<style>

.playvideo {
	position: absolute;
	top:0;
	bottom:0;
	left: 0;
	right: 0;
	margin: 0;
	height: 100%;
	width: 100%;
}
video {
	display: block;
	position: relative;
	top: 5%;
	left: 5%;
	width: 90%;
	height: 90%;
}
</style>


<div  id='playvideo' data-role="page">
	<div data-role='header' data-position='fixed' data-fullscreen='true'>
	<a href=='' class='ui-btn ui-icon-back ui-btn-corner-all ui-btn-icon-notext' data-rel='back'> </a>
	<h1>Video Player</h1>
	</div>
	<div class='playvideo' >
	<video preload='none' controls poster='media/logo-guifibaix-mediateca.png'>
<!--			<source
			src='http://video.webmfiles.org/elephants-dream.webm'
			src='http://video.webmfiles.org/big-buck-bunny_trailer.webm'
			src='http://videos-cdn.mozilla.net/serv/webmademovies/Moz_Doc_0329_GetInvolved_ST.webm'
			type='video/webm'
			media="all and (max-width:480px)"
			/>
-->
	<source
			src='http://videos-cdn.mozilla.net/serv/webmademovies/Moz_Doc_0329_GetInvolved_ST.webm'
			type='video/webm'
			/>
	</video>
</div>

<script type="text/javascript">

function showExtendedInfo(id)
{
	var target = $("#"+id);
	$(".extendedinfoimage").attr("src","");
	$(".extendedinfotype").attr("src","");
	$(".extendedinfotitle").text("No title");
	$(".extendedinfoyear").text("(No year)");
	$(".extendedinfodata").empty();
	$(".movieversions").empty();
	
	var result = $(target).data("omdb");
	setRating(".extendedinfo .extendedinforating", 0);
	var mutedkeys = [
		"Title",
		"Type",
		"Year",
		"imdbID",
		"Poster",
		"imdbRating",
		"imdbVotes",
		"Response",
		"Metascore",
	];
	var sortedkeys = [
		"Genre",
		"Runtime",
		"Country",
		"Language",
		"Plot",
		"Director",
		"Writer",
		"Actors",
		"Seasons",
	];
	var info = $(".extendedinfodata");
	$(info).empty();
	$.each(sortedkeys, function(index, key) {
		if (!(key in result)) return;
		if (result[key] == "N/A") return;
		info.append("<li><b>"+key+":</b> "+result[key]+"</li>");
	});
	$.each(result, function(key, value) {
		if ($.inArray(key, sortedkeys)!=-1) return;
		if ($.inArray(key, mutedkeys)!=-1) return;
		if (value == "N/A") return;
		info.append("<li><b>"+key+":</b> "+value+"</li>");
	});
	var poster = $(".extendedinfoimage")
	loadPoster(poster, result.Poster);
	var typeIcons = {
		'movie': "media/movie.svg",
		'series': "media/show.svg",
		'game': "media/game.svg",
	};
	$(".extendedinfotype").attr('src', typeIcons[result.Type]);
	$(".extendedinfotitle").text(result.Title);
	$(".extendedinfoyear").text("("+result.Year+")");
	setRating(".extendedinfo .extendedinforating", +result.imdbRating/10*100);
	movieTorrents($(".movieversions"), id);
	$(".extendedinfoactions .play").click( function (event) { playVideo(id) });
	setImdbLink(id);
}

function setImdbLink(id)
{
	$(".extendedinfoactions .info").attr("href", "http://imdb.com/title/"+id+"/");
}

function movieTorrents(target, id) {
	var url = "http://yts.re/api/list.jsonp?callback=?&keywords="
		+encodeURIComponent(id);
	console.log("Loading torrents for: "+id);
	var query = $.getJSON(url, function(result){
		console.log(result);
		if (! result.MovieCount ) return;
		$.each(result.MovieList, function(i, movie) {
			$(target).append("<li><a  href='"+movie.TorrentUrl+"'>"+movie.Quality+"</li>");
			console.log(movie);
		});
		$(target).listview("refresh");
	}).fail(function() {
		console.log("Load torrent "+id+" failed: JSON query failed "+url);
	});
}

function setRating(widget, score, max)
{
	if (max==undefined) max=100;
	$(widget).attr("title", score+" / "+max)
	$(widget).find(".rating").css("padding-left", score/max*100+"%");
}


function playVideo(id)
{
	$.mobile.navigate("#playvideo");
}


$(function(){
	$("#mediasearch").autocomplete({
		minLength: 0,
		delay:5,
		source: baseproxyurl+"imdbsuggest.php",
		focus: function( event, ui ) {
			$(this).val( ui.item.value );
			return false;
		},
		select: function( event, ui ) {
			$(this).val( ui.item.value );
			return false;
		}
	}).data("ui-autocomplete")._renderItem = function( ul, item ) {
		return $("<li></li>")
			.data( "item.autocomplete", item )
			.append(
				"<a>" +
				(item.img?
					"<img class='imdbImage' src='"+baseproxyurl+"imdbimage.php?url=" +
						encodeURIComponent(item.img) + "' />":"") + 
				"<span class='imdbTitle'>" + item.label + "</span>" +
				(item.cast?"<br /><span class='imdbCast'>" + item.cast + "</span>":"") +
				"<div class='clear'></div>"+
				"</a>" )
			.appendTo( ul );
	};
	$("#mediasearch").focus(); //Focus on search field
});

var baseproxyurl="http://canvoki.net/mediateca/";

function clearMediaItems() {
//	console.log("Clearing media items");
	$(".itembrowser").empty();
//	console.log("Clearing media items DONE");
}

function loadPoster(poster, uri) {
	if (uri != "N/A" ) {
		poster.attr("onerror", 'this.onerror = null; this.src="media/nocover-movie.png"');
		poster.attr("src",
				baseproxyurl+"imdbimage.php?url="+encodeURIComponent(uri));
			}
	else {
		poster.attr("src","media/nocover-movie.png");
	}
}

function loadMediaItem(id) {
	var item = $('.mediaitem#'+id);
	var url = "http://www.omdbapi.com/?r=JSON&i="+encodeURIComponent(id);
	var query = $.getJSON(url, function(result){
		if ("Error" in result) {
			$(item).remove();
			console.log("Load item "+id+" failed: "+result.Error);
			return;
			}
		$(item).data("omdb", result);
		var poster = $(item).find("img");
		loadPoster(poster, result.Poster);
		$(item).find(".mediadescription").html(result.Title+" ["+result.Type+"] ("+result.Year+")");
	}).fail(function() {
		$(item).remove();
		console.log("Load item "+id+" failed: JSON query failed");
	});
	// TODO: add to a pending list
}

function addMediaItem(id) {
	$(".itembrowser").append(
"	<div class='mediaitem' id='"+id+"'>\n"+
"		<a href='#movieinfo' data-transition='slideup' >\n"+
"		<img class='poster' src='media/loading.gif'>\n"+
"		<div class='mediatitle'>\n"+
"		</div>\n"+
"		<div class='mediadescription'>\n"+
"			Loading info...\n"+
"		</div>\n"+
"		</a>\n"+
"	</div>\n"+
	"")
	$("#"+id).click(function(event) {
		showExtendedInfo(id);
	});
	loadMediaItem(id);
}

function proxiedCall(uri, done, settings)
{
	var proxiedUri= baseproxyurl + "proxy.php?callback=?&url=" + encodeURIComponent(uri);
	var verbose = 'verbose' in settings && settings.verbose==true;
	var failed = 'failed' in settings ? settings.failed : console.log;
	function log(whatever) { if (verbose) console.log(whatever); }

	log("Starting: " + proxiedUri);

	$.getJSON(proxiedUri, function(result) {
		log("Success " + proxiedUri);
		log(result);
		if (result.status.http_code == 200)
			done(result.contents);
		else
			failed(result.status);
	}).fail(function(code, text, headers) {
		log("Failed " + proxiedUri);
		log(text);
		log(headers);
		log(code);
	}).always(function(code, text, headers) {
		log("Done " + proxiedUri);
	});
	log("Started: " + proxiedUri);
}


function addSearchResultsMediaItems(query)
{
	proxiedCall("http://www.imdb.com/xml/find?nr=1&tt=on&json=1&q="+encodeURIComponent(query),
		function (searchResult) {
//			console.log("Doing!!");
			$.each((searchResult), function(index, list) {
				$.each(list, function(type, item) {
					addMediaItem(item.id);
				});
			})
		}, {verbose: false});
}

function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
    });
    return vars;
}

$(function () {
	clearMediaItems();

	var searchtext = getUrlVars().searchtext;
	if (searchtext)
	{
		console.log(searchtext);
		var query = unescape(decodeURIComponent(searchtext));
		console.log(query);
		$("#searchtext").attr("value", query);
		addSearchResultsMediaItems(query);
		return;
	}
	var initialItems = [
		'tt0093870',
		'tt0944947',
		'tt0079501',
		'tt1375666',
	];
	$.each(initialItems, function(index, id) {
		addMediaItem(id);
	});

});

$(document).keyup(function(e) {
	if (e.type=="keyup" && e.keyCode == 27) {
		var currentPage = $.mobile.activePage.attr('id');
		console.log("Escaping from "+currentPage);
		if      (currentPage == "playvideo") $.mobile.back();
		else if (currentPage == "movieinfo") $.mobile.back();
		return false;
	}
	return true;
});

</script>

</body>
</html>
